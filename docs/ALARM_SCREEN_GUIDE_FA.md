# راهنمای صفحه آلارم تمام‌صفحه

## خلاصه تغییرات

در این بروزرسانی، سیستم یادآورها تغییر کرده است تا به جای نمایش نوتیفیکیشن ساده، یک صفحه تمام‌صفحه آلارم نمایش دهد - دقیقاً مثل آلارم‌های ساعت معمولی.

## ویژگی‌های جدید

### 1. صفحه آلارم تمام‌صفحه 📱

- وقتی زمان یادآور می‌رسد، یک صفحه تمام‌صفحه باز می‌شود
- نیازی به کلیک روی نوتیفیکیشن نیست
- کاربر نمی‌تواند آلارم را نادیده بگیرد

### 2. دکمه‌های کنترلی

- **بستن آلارم**: آلارم را متوقف کرده و صفحه را می‌بندد
- **به تعویق انداختن (5 دقیقه)**: آلارم را برای 5 دقیقه دیگر به تعویق می‌اندازد

### 3. طراحی زیبا و کاربرپسند

- انیمیشن ورود با افکت scale
- آیکون بزرگ و واضح
- رنگ‌بندی مناسب و خوانا
- حالت تمام‌صفحه برای جلب توجه کامل

## نحوه کار سیستم

### معماری جدید

```
ReminderRepository
    ↓
SimpleAlarmService (زمان‌بندی با Timer)
    ↓
Callback: onAlarmTriggered
    ↓
main.dart (_showAlarmScreen)
    ↓
AlarmNotificationScreen (صفحه تمام‌صفحه)
```

### فایل‌های تغییر یافته

1. **lib/core/services/simple_alarm_service.dart**

   - حذف وابستگی به `NotificationService`
   - اضافه کردن callback استاتیک `onAlarmTriggered`
   - تغییر متد `_triggerAlarm` برای صدا زدن callback

2. **lib/main.dart**

   - اضافه کردن import برای `SimpleAlarmService`
   - تنظیم callback در `initState`
   - اضافه کردن متد `_showAlarmScreen`

3. **lib/data/repositories/reminder_repository.dart**

   - حذف فیلد استفاده نشده `_notificationService`

4. **lib/presentation/screens/debug/notification_test_screen.dart**
   - بروزرسانی دکمه‌های تست
   - اضافه کردن تست آلارم فوری

## نحوه استفاده

### برای کاربران عادی

1. یک یادآور بسازید (Task یا Goal)
2. زمان را تنظیم کنید
3. فعال بودن یادآور را تایید کنید
4. وقتی زمان برسد، صفحه آلارم به صورت خودکار باز می‌شود
5. می‌توانید آلارم را ببندید یا به تعویق بیندازید

### برای توسعه‌دهندگان

#### ایجاد آلارم به صورت برنامه‌نویسی

```dart
final simpleAlarmService = SimpleAlarmService();

await simpleAlarmService.scheduleSimpleAlarm(
  id: 123,
  title: 'عنوان یادآور',
  body: 'توضیحات یادآور',
  scheduledDateTime: DateTime.now().add(Duration(minutes: 5)),
  reminderId: 'unique_reminder_id',
);
```

#### تنظیم Callback سفارشی

```dart
// در initState یا جایی مناسب
SimpleAlarmService.onAlarmTriggered = (id, title, body, reminderId) {
  // منطق سفارشی شما
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => YourCustomAlarmScreen(...),
    ),
  );
};
```

## تست سیستم

### استفاده از صفحه تست

1. برنامه را اجرا کنید
2. به تب "تست" در نوار پایین بروید
3. روی دکمه **"تست آلارم فوری"** کلیک کنید
4. صفحه آلارم باید فوراً باز شود
5. دکمه "بستن آلارم" را امتحان کنید
6. دوباره دکمه **"تست آلارم صفحه‌باز ۵ ثانیه بعد"** را بزنید
7. 5 ثانیه صبر کنید - صفحه آلارم باید باز شود

### نکات مهم تست

- ✅ آلارم فوری باید بدون تاخیر صفحه را باز کند
- ✅ آلارم زمان‌بندی شده باید دقیقاً بعد از زمان تعیین شده فعال شود
- ✅ دکمه "بستن آلارم" باید صفحه را ببندد
- ✅ دکمه "به تعویق انداختن" باید یادآور جدیدی برای 5 دقیقه بعد ایجاد کند
- ✅ سیستم بدون نیاز به نوتیفیکیشن‌های سیستمی کار می‌کند

## مزایای این رویکرد

1. **تجربه کاربری بهتر**: کاربر نمی‌تواند یادآور را نادیده بگیرد
2. **بدون نیاز به مجوز نوتیفیکیشن**: حتی اگر مجوز نوتیفیکیشن داده نشده باشد، کار می‌کند
3. **کنترل بیشتر**: طراحی و رفتار صفحه کاملاً تحت کنترل ماست
4. **سادگی**: نیازی به پیکربندی پیچیده نوتیفیکیشن نیست
5. **قابل اطمینان‌تر**: مشکلات نوتیفیکیشن Android را دور می‌زند

## محدودیت‌ها

1. **فقط وقتی برنامه باز است**: اگر برنامه در background باشد، آلارم فعال نمی‌شود
   - برای حل این مشکل، می‌توان از `android_alarm_manager_plus` استفاده کرد
2. **Timer از بین می‌رود**: اگر برنامه force close شود، timerها از بین می‌روند
   - با `rescheduleAllActiveReminders()` در startup این مشکل حل می‌شود

## پیشنهادات برای آینده

1. ✨ اضافه کردن صدای آلارم سفارشی
2. ✨ اضافه کردن ویبره
3. ✨ امکان تنظیم زمان snooze سفارشی
4. ✨ نمایش تصویر یا اطلاعات بیشتر در صفحه آلارم
5. ✨ استفاده از `android_alarm_manager_plus` برای کار در background
6. ✨ Wake lock برای روشن نگه داشتن صفحه

## خطایابی (Troubleshooting)

### صفحه آلارم باز نمی‌شود

1. مطمئن شوید برنامه باز است (در foreground)
2. بررسی کنید که callback در `main.dart` تنظیم شده باشد
3. لاگ‌های console را چک کنید
4. از صفحه تست برای debugging استفاده کنید

### Timer اجرا نمی‌شود

1. زمان را با `DateTime.now()` مقایسه کنید
2. مطمئن شوید زمان در آینده است
3. بررسی کنید که `scheduleSimpleAlarm` خطا نداده باشد

### دکمه "به تعویق انداختن" کار نمی‌کند

1. مطمئن شوید `NotificationService` مقداردهی اولیه شده است
2. بررسی کنید که `scheduleNotification` خطا نداده باشد
3. لاگ‌های console را چک کنید

## پشتیبانی

اگر مشکلی با این ویژگی دارید:

1. ابتدا صفحه تست را امتحان کنید
2. لاگ‌های console را بررسی کنید
3. مطمئن شوید همه فایل‌ها به‌روز هستند
4. در صورت نیاز، issue در repository ایجاد کنید

---

**نسخه**: 2.0  
**تاریخ به‌روزرسانی**: اکتبر 2025  
**سازگاری**: Flutter 3.x
