# راهنمای استفاده از آلارم (Alarm Guide)

## تغییرات انجام شده برای رفع مشکل آلارم

### 1. اضافه شدن مجوزهای لازم در AndroidManifest.xml
مجوزهای زیر برای عملکرد صحیح آلارم اضافه شده‌اند:
- `SCHEDULE_EXACT_ALARM` - برای زمان‌بندی دقیق آلارم در اندروید 12+
- `USE_EXACT_ALARM` - برای استفاده از آلارم دقیق در اندروید 13+
- `POST_NOTIFICATIONS` - برای نمایش نوتیفیکیشن در اندروید 13+
- `VIBRATE` - برای لرزش گوشی هنگام آلارم
- `WAKE_LOCK` - برای بیدار کردن گوشی هنگام آلارم
- `RECEIVE_BOOT_COMPLETED` - برای بازگردانی آلارم‌ها بعد از ری‌استارت
- `USE_FULL_SCREEN_INTENT` - برای نمایش تمام صفحه آلارم

### 2. تنظیم Timezone
تایم‌زون به صورت پیش‌فرض روی `Asia/Tehran` تنظیم شده است. اگر در کشور دیگری هستید، می‌توانید در فایل `lib/core/services/notification_service.dart` خط 23 را تغییر دهید:

```dart
tz.setLocalLocation(tz.getLocation('Asia/Tehran')); // تغییر دهید به timezone مورد نظر
```

### 3. بازگردانی آلارم‌ها بعد از ری‌استارت
سیستم خودکار بازگردانی آلارم‌ها بعد از ری‌استارت گوشی پیاده‌سازی شده است.

## مراحل استفاده

### 1. نصب مجدد اپلیکیشن
برای اعمال تغییرات AndroidManifest.xml باید اپلیکیشن را مجدداً نصب کنید:

```bash
flutter clean
flutter pub get
flutter run
```

### 2. بررسی مجوزها
وقتی اپلیکیشن را برای اولین بار اجرا می‌کنید، باید مجوزهای زیر را بدهید:
- اجازه نمایش نوتیفیکیشن
- اجازه زمان‌بندی آلارم دقیق

### 3. تنظیم آلارم
1. یک Task یا Goal ایجاد کنید
2. زمان یادآوری (Reminder) را تنظیم کنید
3. در صورت تمایل، یک صدای سفارشی برای آلارم انتخاب کنید
4. آلارم را ذخیره کنید

## مشکلات رایج و راه‌حل‌ها

### آلارم هنوز کار نمی‌کند
1. **بررسی مجوزها:**
   - Settings > Apps > Self Management > Permissions
   - مطمئن شوید تمام مجوزها فعال هستند

2. **بررسی تنظیمات باتری:**
   - Settings > Apps > Self Management > Battery
   - گزینه "Unrestricted" یا "بدون محدودیت" را انتخاب کنید
   - برخی گوشی‌ها (مثل Xiaomi, Huawei) نیاز به تنظیمات اضافی دارند

3. **بررسی زمان آلارم:**
   - مطمئن شوید زمان آلارم در آینده است
   - زمان گوشی را بررسی کنید (تاریخ و ساعت صحیح باشد)

4. **بررسی لاگ‌ها:**
   - اپلیکیشن را در حالت debug اجرا کنید
   - لاگ‌های مربوط به `NotificationService` را بررسی کنید

### آلارم بعد از ری‌استارت گوشی حذف می‌شود
این مشکل با پیاده‌سازی سیستم reschedule حل شده است. اما در برخی گوشی‌ها نیاز است:
- Settings > Apps > Self Management
- گزینه "Autostart" یا "اجرای خودکار" را فعال کنید

### برای گوشی‌های Xiaomi (MIUI)
1. Settings > Apps > Manage apps > Self Management
2. Battery saver: No restrictions
3. Autostart: Enabled
4. Other permissions: Allow all

### برای گوشی‌های Huawei
1. Settings > Apps > Apps > Self Management
2. Battery > App launch > Self Management > Manage manually
3. فعال کردن: Auto-launch, Secondary launch, Run in background

## تست آلارم

### تست سریع
1. یک آلارم برای 2 دقیقه بعد تنظیم کنید
2. اپلیکیشن را ببندید (force stop نکنید)
3. صبر کنید تا آلارم فعال شود
4. باید نوتیفیکیشن نمایش داده شود و صدا پخش شود

### تست بعد از ری‌استارت
1. یک آلارم برای 5 دقیقه بعد تنظیم کنید
2. گوشی را ری‌استارت کنید
3. بعد از روشن شدن گوشی، منتظر بمانید
4. آلارم باید در زمان تعیین شده فعال شود

## نکات مهم

1. **نصب مجدد الزامی است**: برای اعمال تغییرات AndroidManifest.xml حتماً اپلیکیشن را uninstall کرده و دوباره نصب کنید

2. **تست در حالت Release**: برخی مشکلات فقط در حالت debug رخ می‌دهد. برای اطمینان، یک نسخه release بسازید و تست کنید:
   ```bash
   flutter build apk --release
   ```

3. **بررسی Pending Notifications**: می‌توانید در کد از متد `getPendingNotifications()` استفاده کنید تا لیست آلارم‌های زمان‌بندی شده را ببینید

4. **Timezone**: اگر آلارم در زمان اشتباهی فعال می‌شود، timezone را بررسی کنید

## پشتیبانی

اگر بعد از انجام تمام مراحل بالا هنوز مشکل دارید:
1. لاگ‌های اپلیکیشن را بررسی کنید
2. مدل و نسخه اندروید گوشی خود را بررسی کنید
3. یک issue در پروژه ایجاد کنید با جزئیات کامل:
   - مدل گوشی
   - نسخه اندروید
   - مراحلی که انجام داده‌اید
   - لاگ‌های خطا

